; stunnel configuration for SMTP STARTTLS on port 587.
;
; Terminates TLS inside the container to avoid sendmail's
; OpenSSL 3.x TLS renegotiation incompatibility. stunnel handles
; the SMTP STARTTLS negotiation (protocol = smtp), performs a
; single TLS handshake, and proxies decrypted traffic to sendmail
; on localhost port 25.

pid = /var/run/stunnel/stunnel.pid

; Run in foreground for supervisord process management.
foreground = yes

; Write to /var/log/maillog directly so the log-tailer picks up
; stunnel messages and ships them to CloudWatch.
output = /var/log/maillog

[smtp-starttls]
accept = 587
connect = 127.0.0.1:25

; Server mode (accept incoming connections).
client = no

; Handle SMTP STARTTLS negotiation: stunnel sends the 220
; greeting, responds to EHLO with STARTTLS capability, and
; negotiates TLS when the client sends the STARTTLS command.
; After TLS is established, it connects to sendmail on port 25
; and proxies transparently.
protocol = smtp

; TLS certificate paths (rendered from __CERT_DOMAIN__ template).
cert = /etc/pki/tls/certs/__CERT_DOMAIN__.crt
key = /etc/pki/tls/private/__CERT_DOMAIN__.key
CAfile = /etc/pki/tls/certs/__CERT_DOMAIN__.ca-bundle

; Security: disable legacy protocols.
options = NO_SSLv2
options = NO_SSLv3
sslVersionMin = TLSv1.2
