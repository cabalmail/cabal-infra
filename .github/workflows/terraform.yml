---
name: Build and Deploy Terraform Infrastructure

on:
  workflow_dispatch:
  repository_dispatch:
    types: [trigger_build_dev]
  push:
    branches:
      - '0.3.0'
      - main
      - stage
    paths:
      - 'terraform/infra'
      - 'terraform/infra/*'
      - 'terraform/infra/*/**'
      - '.github/workflows/terraform.yml'
jobs:
  checkov:
    runs-on: ubuntu-latest
    steps:
    - name: checkout
      uses: actions/checkout@master@v2
    - name: chekov
      uses: bridgecrewio/checkov-action@master
      with:
        directory: terraform/infra/
        quiet: true
        soft_fail: false
        framework: terraform
        download_external_modules: false
  tflint:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./terraform/infra
    steps:
    - name: checkout
      uses: actions/checkout@v2
    - name: install-linters
      run: curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
    - name: initialize-linter
      run: tflint --version && tflint --init
    - name: run-linter
      run: for i in ./ modules/* modules/*/modules/* ; do tflint ; done
